#########################################################################################################
################################## IN GROUPE COPYRIGHT  #################################################
stages:  
  - build_and_deploy

variables:
  MAVEN_GROUPEID: com.ingroupe.efti
  MAVEN_ARTIFACTID: platform-gate-simulator
  MAVEN_EXTENSION: jar
  VERSION_ARTEFACT_SNAPSHOT: 1.0.0-SNAPSHOT
  VERSION_ARTEFACT_RELEASE: 1.0.0
  DEPLOY_ENVIRONMENT:
    value: "dev"
    options:
      - "dev"
      - "int"
    description: "The deployment target. Set to 'dev' by default."
  REBUILD_COMPONENT_IMAGE:
    value: "true"
    options:
      - "true"
      - "false"
    description: "Allow to rebuild or no the component Image. Set to 'true' by default."
  LABEL:
    value: "NONE"
    options:
      - "NONE"
      - "fr"
      - "bo"
      - "li"
      - "sy"
    description: "The label of component. Set to 'NONE' by default."

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "api"
    - if: $CI_PIPELINE_SOURCE == "web"
    - if: $CI_PIPELINE_SOURCE == "push"
      when: never
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
      when: never
    - if: $CI_COMMIT_REF_NAME !~ "develop"
      when: never
    - if: $DEPLOY_ENVIRONMENT == "dev"
      variables:
        NAMESPACE_DEV: app-dev-efti-mock
        CONTEXT: dev-efti-mock
    - if: $DEPLOY_ENVIRONMENT == "int"
      variables:
        NAMESPACE: app-int-efti-mock
        CONTEXT: int-efti-mock
    - when: always

build_microservices:
  stage: build_and_deploy
  rules:
    - if: $CI_COMMIT_REF_NAME =~ /feat/
      variables:
        TAG: PREVIEW
      when: manual
    - when: always
  trigger:
    include:
      - project: "kube/build"
        file: "build_ms.yml"
        ref: "mock"
    forward:
      pipeline_variables: true
    strategy: depend
